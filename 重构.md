# 重构项目：具身智能机器人后端 V2

> 本文档定义 **具身智能机器人后端 V2** 的整体架构原则、进程边界、API 职责划分与工程约束。
> 本重构目标是：**在不牺牲实时性与安全性的前提下，实现可扩展、可维护、可远程化的机器人后端架构**。

---

## 1. 设计目标（Design Goals）

1. **实时控制不走 Web**

   * 所有控制闭环 **必须在机器人本体（ROS2 Runtime）内完成**
   * Web 仅用于表达 *意图（Intent）*，不参与控制闭环

2. **清晰的职责分离**

   * 管理 ≠ 实时 ≠ 多媒体
   * 不允许“一个进程什么都干”

3. **面向未来的远程化**

   * 架构必须支持：

     * 局域网 VR 遥操
     * 跨公网（NAT / 5G / 云端）访问
     * 多客户端并发（Web / VR / 运维）

4. **工程可落地**

   * Jetson AGX Orin 资源受限
   * CPU、内存、功耗必须可控
   * 避免“学术级但不可部署”的方案

---

## 2. 总体架构概览（三进程模型）

```text
┌──────────────────────────────────┐
│           Client Layer            │
│   Web UI / VR / 运维 / 云端        │
└──────────────▲───────────────────┘
               │
┌──────────────┴───────────────────┐
│           API Layer               │
│                                   │
│  FastAPI        WebSocket         │
│ (Control Plane) (Data Plane)      │
│                                   │
│          GStreamer + WebRTC       │
│          (Media Plane)            │
└──────────────▲───────────────────┘
               │
┌──────────────┴───────────────────┐
│        Robot Runtime Layer        │
│   ROS2 / Drivers / Control Loop  │
│   Watchdog / Safety / Recorder   │
└──────────────────────────────────┘
```

---

## 3. 核心原则（必须遵守）

### 3.1 物理隔离（Process-Level Isolation）

严格遵循以下三进程架构：

| 进程                     | 职责                  | 说明      |
| ---------------------- | ------------------- | ------- |
| **FastAPI**            | 管理平面（Control Plane） | 低频、强一致  |
| **WebSocket Server**   | 数据平面（Data Plane）    | 中高频、低延迟 |
| **GStreamer / WebRTC** | 媒体平面（Media Plane）   | 超高吞吐    |

> ❗ **禁止将三者合并为单一进程**

---

### 3.2 禁止事项（Hard Rules）

#### FastAPI 禁止事项

* ❌ 使用 `asyncio.sleep()` 实现任何形式的高频循环
* ❌ 订阅 ROS Topic 并持续推流
* ❌ 承载 WebSocket 高频状态流
* ❌ 承载视频 / 图像流

#### WebSocket 禁止事项

* ❌ 发送大体积 JSON（JointState / TF / 点云）
* ❌ 无时间戳的数据包
* ❌ 无 Watchdog 保护的控制指令

#### 全局禁止

* ❌ Web 协议参与实时控制闭环
* ❌ 前端数据作为训练数据源
* ❌ 控制指令不设超时保护

---

## 4. API 分层与职责定义

### 4.1 FastAPI（管理平面 / Control Plane）

**定位**：

> 负责 *“谁在控制、控制什么、什么时候开始/结束”*

#### 使用场景

* 用户认证 / 鉴权
* 机器人信息查询
* 工作模式切换（idle / teleop / auto）
* 任务生命周期管理
* 参数配置 / 标定
* 日志与状态摘要

#### 特征

* 频率：`< 5 Hz`
* 协议：HTTP REST
* 强一致性、可追溯

---

### 4.2 WebSocket（数据平面 / Data Plane）

**定位**：

> 负责 *“连续变化的控制意图与状态流”*

#### 使用场景

* VR / 遥操控制意图
* 关节状态、TF、IMU 等高频状态
* Planning / Execution 状态反馈

#### 设计约束

* 必须支持二进制格式（Protobuf / Flatbuffers）
* 所有消息 **必须携带时间戳**
* 必须配合 **Jetson 本地 Watchdog**

#### 推荐实现

* C++ WebSocket Server

---

### 4.3 GStreamer + WebRTC（媒体平面 / Media Plane）

**定位**：

> 负责 *“人类感知所需的多媒体数据”*

#### 使用场景

* RGB 视频
* 多视角摄像头
* 低延迟遥操画面

#### 设计约束

* 必须使用硬件编码（Jetson NVENC）
* 禁止通过 WebSocket / HTTP 传输视频
* 所有帧需附带系统时间戳

---

## 5. 数据与时间戳原则（具身智能关键）

1. **统一时间源**

   * 所有 ROS 消息、视频帧、控制意图使用同一系统时钟

2. **训练数据录制位置**

   * ✅ 机器人本体（rosbag / mcap）
   * ❌ Web / VR / 浏览器

3. **API 数据仅用于**

   * 可视化
   * 遥操
   * 调试与运维

---

## 6. 安全与失效保护（Safety First）

### 6.1 Watchdog（必选）

* 所有遥操控制必须经过 Watchdog
* 若超过 **200ms** 未收到有效控制意图：

  * 立即停止机械臂 / 底盘
  * 切换至安全状态

### 6.2 网络异常假设

> **必须假设网络随时中断**

* TCP / WebSocket 重连不可作为安全手段
* 安全逻辑必须在 ROS2 Runtime 内

---

## 7. 技术栈与工程规范

### 7.1 技术栈

* Python 3.10+
* FastAPI
* Pydantic V2

  * 使用 `model_validate`
  * 禁止使用 `from_orm`
* ROS2 (`rclpy`)
* GStreamer
* WebRTC

---

### 7.2 代码风格与规范

* 所有 API 必须提供完整 **Type Hints**
* 使用 **Google Style Docstrings**
* 模块职责清晰，禁止跨层调用
* API 层禁止直接操作硬件

---

## 8. 本文档的约束级别

> 本文档中标注的 **禁止事项 / 必须 / 不允许**
> 属于 **架构级硬约束（Hard Constraint）**，
> 不因开发便利性、Demo 需求而破例。

---

## 9. 版本说明

* **V2 目标**：
  从“可演示系统”升级为“可长期演进的机器人平台后端”


