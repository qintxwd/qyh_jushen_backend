# 重构补充说明（V2）

> 本文档是《具身智能机器人后端 V2 重构.md》的 **工程级补充说明**，
> 旨在解决 **多进程协作、远程接入、调试运维与硬件资源约束** 等落地问题。
>
> 本文档不改变原有三进程架构原则，仅补充 **实施细节与工程约束**。

---

## 1. 服务发现与配置下发（Service Discovery）

### 1.1 设计原则

* 前端 **只允许** 硬编码 FastAPI 地址
* 其他所有服务地址 **必须动态获取**
* FastAPI 是 **系统配置的唯一权威源（Source of Truth）**

---

### 1.2 配置发现接口（必须实现）

**接口定义**：

```http
GET /api/v1/system/config
```

**示例响应**：

```json
{
  "robot_id": "${sn}",
  "endpoints": {
    "websocket": "ws://192.168.1.100:8765",
    "webrtc_signaling": "http://192.168.1.100:8888"
  },
  "webrtc": {
    "ice_servers": ["stun:stun.l.yuanchang.com:19302"]
  }
}
```

### 1.3 工程约束

* ❌ 禁止前端写死 WebSocket / WebRTC 地址
* ✅ 允许 FastAPI 根据网络环境（LAN / WAN）返回不同配置

---

## 2. 跨进程统一鉴权（Unified Authentication）

### 2.1 总体原则

* **FastAPI 负责身份认证**
* **所有其他进程只做 Token 校验**
* 不允许各进程独立实现登录逻辑

---

### 2.2 鉴权流程（推荐，Session-Level）

1. **FastAPI 负责身份认证**

   * 签发 JWT（包含 user_id / role / permissions）

2. **连接建立阶段鉴权**

   * WebSocket：

     * 在 HTTP Upgrade 阶段携带 JWT（Header 或 Query）
     * 鉴权失败直接拒绝连接
   * WebRTC：

     * 在 Signaling HTTP 接口中携带 JWT
     * 鉴权成功后建立 WebRTC 会话

3. **会话级信任模型**

   * WebSocket / WebRTC 连接建立后：

     * 不再在数据帧中携带 Token
     * 会话上下文保存用户身份与权限信息

4. **权限校验**

   * 控制类消息需校验会话权限（只读 / 遥操 / 管理）
   * 状态订阅可根据角色进行降级或限流

> ❗ 禁止在高频数据帧中重复携带或校验 Token


---

### 2.3 工程取舍说明

* 内网 Demo 阶段：

  * 可临时关闭 WebSocket Token 校验
* 但 **接口结构必须预留鉴权字段**
* ❌ 禁止“以后再补鉴权”的设计

---

## 3. 进程心跳与熔断策略（Health & Failover）

### 3.1 系统健康监控节点（建议）

在 ROS2 Runtime 中运行一个轻量级守护节点：

* 不参与控制
* 不占用实时线程
* 仅监控系统状态

---

### 3.2 推荐策略矩阵

| 故障源            | 系统行为                |
| -------------- | ------------------- |
| FastAPI 进程异常   | 禁止新任务 / 模式切换，维持当前状态 |
| WebSocket 进程异常 | 立即触发 Soft Stop      |
| WebRTC 进程异常    | 速度归零 / 悬停，禁止盲操      |
| 网络完全中断         | 触发本地安全策略            |

---

### 3.3 设计铁律

> **任何“依赖网络的信号”，都不能作为安全保障**

---

## 4. 日志与调试规范（Observability）

### 4.1 日志统一原则

* 所有进程 **必须运行在 systemd 管理下**
* 标准输出交由 journald 接管
* 禁止“只在 terminal 里打印”

---

### 4.2 日志分工建议

| 模块        | 日志特点              |
| --------- | ----------------- |
| FastAPI   | JSON / request-id |
| WebSocket | 连接 / 帧率 / 延迟      |
| ROS2      | 节点级 console log   |
| GStreamer | 仅 error / warning |

---

### 4.3 运维约定（示例）

```bash
journalctl -u robot-fastapi -f
journalctl -u robot-ws -f
journalctl -u robot-media -f
```

---

## 5. Jetson AGX Orin 资源使用建议

> 本节为 **性能稳定性建议**，非强制实时系统要求。

### 5.1 性能模式

* 启动时建议执行：

  ```bash
  sudo nvpmodel -m 0
  sudo jetson_clocks
  ```

---

### 5.2 CPU 使用建议

| 模块                 | 建议              |
| ------------------ | --------------- |
| ROS2 控制 / Watchdog | 优先级最高           |
| GStreamer          | 依赖 NVENC，CPU 次要 |
| FastAPI            | 最低优先级           |

---

### 5.3 设计原则

* ❌ 不允许视频推流影响控制周期
* ❌ 不允许 AI 推理阻塞 Watchdog

---

## 6. 本补充文档的定位

* 本文档是 **工程落地补充**
* 不与主《重构.md》产生冲突
* 当补充与主文档冲突时：

  * **以主文档的“核心原则”为准**


在机器人场景里，还有一个 **Web 系统没有的额外维度**：

### ✅ 会话 = 控制权

* 同一时间：

  * 只能有 **一个 Teleop Session** 拥有控制权
* 新会话接入：

  * 必须抢占 / 被拒绝 / 只读

这个逻辑：

* ❌ 不属于 JWT
* ✅ 属于 **机器人状态机**
